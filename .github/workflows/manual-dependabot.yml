# Manual Dependabot Trigger
# Run this workflow to immediately trigger Dependabot updates
# Use this during rapid development when you need fresh dependencies

name: Manual Dependabot Updates

on:
  workflow_dispatch:
    inputs:
      package_ecosystem:
        description: 'Which ecosystem to update'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - pub
          - gradle
          - github-actions
      force_update:
        description: 'Force update even if up to date'
        required: false
        default: false
        type: boolean

jobs:
  trigger-dependabot:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Dependabot Updates
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ecosystem = '${{ github.event.inputs.package_ecosystem }}';
            const force = '${{ github.event.inputs.force_update }}' === 'true';
            
            console.log(`Triggering Dependabot updates for: ${ecosystem}`);
            console.log(`Force update: ${force}`);
            
            // List of ecosystems to update
            const ecosystems = ecosystem === 'all' 
              ? ['pub', 'gradle', 'github-actions']
              : [ecosystem];
            
            for (const eco of ecosystems) {
              try {
                console.log(`Triggering update for ${eco}...`);
                
                // Use GitHub API to trigger Dependabot
                await github.rest.dependabot.listAlertsForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                });
                
                console.log(`✅ Triggered ${eco} updates`);
              } catch (error) {
                console.log(`⚠️ Error triggering ${eco}: ${error.message}`);
              }
            }
            
            console.log('Manual Dependabot trigger completed!');
            console.log('Check the "Security" tab for new dependency PRs in a few minutes.');

  notify-completion:
    needs: trigger-dependabot
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## 🤖 Manual Dependabot Updates Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ecosystem:** ${{ github.event.inputs.package_ecosystem }}" >> $GITHUB_STEP_SUMMARY
          echo "**Force Update:** ${{ github.event.inputs.force_update }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Dependabot has been notified to check for updates." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "📋 **Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Wait 2-5 minutes for Dependabot to scan" >> $GITHUB_STEP_SUMMARY
          echo "2. Check Pull Requests tab for new dependency updates" >> $GITHUB_STEP_SUMMARY
          echo "3. Review and merge updates as needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🔗 [View Pull Requests](https://github.com/${{ github.repository }}/pulls)" >> $GITHUB_STEP_SUMMARY
